---
sidebar_position: 3
---

# 高级特性

Axvisor 的构建系统包含了许多高级特性，这些特性使得它能够处理复杂的虚拟化场景和多平台支持需求。这些特性的设计体现了现代软件开发的最佳实践，特别是在处理复杂的系统级软件时。

## 多架构支持

构建系统支持多种目标架构，这是虚拟机监视器项目的基本要求。每个架构都有特定的编译选项、链接脚本和运行时需求，构建系统必须能够智能地处理这些差异。

支持的目标架构：

- `aarch64-unknown-none-softfloat`：ARM64 架构，无操作系统，软浮点
- `x86_64-unknown-none`：x86_64 架构，无操作系统
- `riscv64gc-unknown-none-elf`：RISC-V 64位架构，通用，无操作系统

通过 `rust-toolchain.toml` 配置：

```toml
[toolchain]
profile = "minimal"
channel = "nightly-2025-05-20"
components = ["rust-src", "llvm-tools", "rustfmt", "clippy"]
targets = ["x86_64-unknown-none", "riscv64gc-unknown-none-elf", "aarch64-unknown-none-softfloat"]
```

这种配置确保了所有开发者使用相同版本的 Rust 工具链，避免了因工具链版本不一致导致的问题。同时，通过指定 `nightly` 版本，项目可以使用最新的 Rust 特性和优化，这对于系统级软件开发特别重要。

多架构支持的实现还包括：
- **条件编译**：使用 `cfg` 属性根据目标架构编译不同的代码
- **架构特定优化**：为不同架构提供特定的编译选项和优化
- **链接脚本适配**：根据架构生成不同的内存布局和链接配置
- **测试覆盖**：确保所有架构的代码都经过充分测试

## 特性管理

项目支持多种构建特性，这些特性控制着编译时包含的功能和优化。特性系统允许同一个代码库支持不同的配置需求，从最小化的嵌入式系统到功能齐全的虚拟化平台。

主要构建特性：

- `ept-level-4`: 4级EPT页表支持，用于大内存虚拟化
- `fs`: 文件系统支持，用于客户机文件访问
- `axstd/myplat`: 自定义平台支持，用于特定硬件平台
- `axstd/bus-mmio`: MMIO总线支持，用于内存映射I/O设备

特性系统的设计使得开发者可以根据具体需求定制构建，减少不必要的代码和内存占用。这对于嵌入式和虚拟化环境特别重要，因为资源通常有限。

特性管理的实现包括：
- **依赖解析**：自动处理特性之间的依赖关系
- **冲突检测**：防止不兼容的特性组合
- **默认配置**：为常见使用场景提供合理的默认特性组合
- **文档化**：为每个特性提供清晰的文档和使用示例

## 环境变量控制

构建系统通过环境变量提供了灵活的配置机制，这些变量可以在不修改配置文件的情况下调整构建行为。这种设计使得构建系统可以与 CI/CD 系统和其他工具链集成，提供了额外的灵活性。

主要环境变量：

- `AXVISOR_SMP`: 设置CPU核心数，用于多核处理器支持
- `AXVISOR_VM_CONFIGS`: 指定虚拟机配置文件路径，支持多个配置文件
- `AX_CONFIG_PATH`: ArceOS配置文件路径，用于底层系统配置

环境变量系统的设计考虑了：
- **默认值**：为所有环境变量提供合理的默认值
- **验证**：检查环境变量值的有效性，提供清晰的错误信息
- **文档**：在构建脚本中记录所有支持的环境变量及其用途
- **兼容性**：确保环境变量与配置文件系统的一致性

## 代码质量保证

[`clippy.rs`](https://github.com/arceos-hypervisor/axvisor/tree/next/xtask/src/clippy.rs) 实现了全面的代码质量检查系统，这是确保项目长期可维护性的关键组件。代码质量检查不仅仅是发现错误，更是维护代码风格、性能和安全性的重要工具。

代码质量检查功能：

1. **多目标架构检查**：确保代码在所有支持的目标架构上都能正确编译
2. **特性组合检查**：测试各种特性组合，避免特性冲突
3. **自动修复支持**：自动修复常见的代码问题，提高开发效率
4. **详细的统计报告**：提供全面的检查结果统计，帮助跟踪代码质量趋势

这个系统的设计考虑了大型项目的实际需求，包括：
- **并行检查**：利用多核处理器并行执行检查，提高效率
- **增量检查**：只检查修改的文件，减少不必要的重复工作
- **分类报告**：将问题按严重程度分类，帮助开发者优先处理重要问题
- **集成支持**：与 CI/CD 系统集成，自动阻止低质量代码合并

代码质量保证还包括：
- **性能分析**：检查潜在的性能问题和优化机会
- **安全审计**：识别常见的安全漏洞和不良实践
- **文档检查**：确保公共 API 有适当的文档
- **测试覆盖**：监控测试覆盖率，确保代码充分测试
